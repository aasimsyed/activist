services:
  # Override backend service for E2E: fix health check and add start period
  backend:
    environment:
      - BACKEND_PORT=${BACKEND_PORT}
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "curl -f http://localhost:$BACKEND_PORT/v1/schema/ || exit 1",
        ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 120s

  # Override frontend service for E2E: add --host 0.0.0.0 and fix health check
  frontend:
    command: sh -c "
      corepack enable && yarn install &&
      if [ \"$${USE_PREVIEW}\" = \"true\" ]; then
      echo 'ðŸ—ï¸  Building frontend for preview mode...' &&
      yarn build &&
      echo 'â–¶ï¸  Starting preview server on port ${FRONTEND_PORT}...' &&
      yarn preview --host 0.0.0.0 --port ${FRONTEND_PORT};
      else
      echo 'â–¶ï¸  Starting dev server...' &&
      yarn dev --host 0.0.0.0 --port ${FRONTEND_PORT};
      fi"
    environment:
      - USE_PREVIEW=${USE_PREVIEW:-false}
      - FRONTEND_PORT=${FRONTEND_PORT}
      - VITE_BACKEND_URL=${VITE_BACKEND_URL}
    healthcheck:
      test:
        ["CMD-SHELL", "curl -f http://localhost:$FRONTEND_PORT/ || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 60s

  e2e-test:
    env_file:
      - .env.dev
    build:
      context: ./frontend
      dockerfile: Dockerfile.e2e
    container_name: e2e-test
    depends_on:
      frontend:
        condition: service_healthy
      backend:
        condition: service_healthy
    environment:
      - BASE_URL=http://frontend:3000
      - PLAYWRIGHT_BASE_URL=http://frontend:3000
      - TEST_ENV=local
      - SKIP_WEBSERVER=true
    volumes:
      - ./frontend:/app
    command:
      - sh
      - -c
      - |
        echo "Waiting for frontend to be healthy..." &&
        until curl -f http://frontend:3000/ > /dev/null 2>&1; do
          echo "Frontend not ready yet, waiting..."
          sleep 2
        done &&
        echo "Waiting for backend to be healthy..." &&
        until curl -f http://backend:$${BACKEND_PORT:-8000}/v1/schema/ > /dev/null 2>&1; do
          echo "Backend not ready yet, waiting..."
          sleep 2
        done &&
        echo "Warming up backend endpoints..." &&
        curl -s -X OPTIONS http://backend:$${BACKEND_PORT:-8000}/v1/auth/sign_in > /dev/null || true &&
        curl -s http://backend:$${BACKEND_PORT:-8000}/v1/entities/users/ > /dev/null || true &&
        curl -s http://backend:$${BACKEND_PORT:-8000}/v1/entities/organizations/ > /dev/null || true &&
        curl -s http://backend:$${BACKEND_PORT:-8000}/v1/entities/events/ > /dev/null || true &&
        echo "Waiting 3 seconds for backend to fully initialize..." &&
        sleep 3 &&
        echo "Container up and running....." &&
        corepack enable &&
        yarn install --immutable &&
        yarn playwright install &&
        echo "Running Playwright tests..." &&
        yarn test:local
