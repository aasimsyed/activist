services:
  # Reuse services from docker-compose.yml using extends
  db:
    extends:
      file: docker-compose.yml
      service: db

  # Override backend service for E2E: fix health check and add start period
  backend:
    extends:
      file: docker-compose.yml
      service: backend
    environment:
      - BACKEND_PORT=${BACKEND_PORT}
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "curl -f http://localhost:$BACKEND_PORT/v1/schema/ || exit 1",
        ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 120s

  # Override frontend service for E2E: always use preview mode for best performance
  # Preview mode is required for E2E tests - guarantees pre-built static files
  frontend:
    extends:
      file: docker-compose.yml
      service: frontend
    command: sh -c "
      corepack enable && yarn install &&
      echo 'üèóÔ∏è  Building frontend for preview mode...' &&
      yarn build &&
      echo '‚ñ∂Ô∏è  Starting preview server on port ${FRONTEND_PORT}...' &&
      yarn preview --host 0.0.0.0 --port ${FRONTEND_PORT}"
    environment:
      # Preview mode is hardcoded for E2E - no conditional check
      - USE_PREVIEW=true
      - FRONTEND_PORT=${FRONTEND_PORT}
      # Browsers launched by Playwright may have DNS resolution issues. Since the browser can
      # access http://frontend:3000 (via PLAYWRIGHT_BASE_URL), it should also resolve 'backend'.
      # However, if DNS doesn't work, use host.docker.internal (Mac/Windows) or add extra_hosts.
      # The backend port is exposed, so browsers should be able to reach it via service name.
      - VITE_BACKEND_URL=http://backend:${BACKEND_PORT:-8000}
    healthcheck:
      test:
        ["CMD-SHELL", "curl -f http://localhost:$FRONTEND_PORT/ || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 60s

  e2e-test:
    env_file:
      - .env.dev
    build:
      context: ./frontend
      dockerfile: Dockerfile.e2e
    container_name: e2e-test
    depends_on:
      - frontend
      - backend
    # Add extra_hosts for host.docker.internal (Linux compatibility)
    # This allows browsers to access exposed host ports if Docker service names don't resolve
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      - BASE_URL=http://frontend:3000
      - PLAYWRIGHT_BASE_URL=http://frontend:3000
      - TEST_ENV=local
      - SKIP_WEBSERVER=true
      # Set CI=true to ensure global-setup.ts runs full server readiness check
      # (checks for Nuxt compilation completion, not just basic HTTP response)
      - CI=true
      # Use 1 worker in Docker for better resource utilization and stability
      - PLAYWRIGHT_WORKERS=1
    volumes:
      - ./frontend:/app
    command:
      - sh
      - -c
      - |
        corepack enable &&
        yarn install &&
        yarn playwright install &&
        echo "Running Playwright tests..." &&
        yarn test:local
