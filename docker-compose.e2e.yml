services:
  e2e-test:
    env_file:
      - .env.dev
    build:
      context: ./frontend
      dockerfile: Dockerfile.e2e
    container_name: e2e-test
    depends_on:
      frontend:
        condition: service_healthy
      backend:
        condition: service_healthy
    environment:
      - BASE_URL=http://frontend:3000
      - PLAYWRIGHT_BASE_URL=http://frontend:3000
      - TEST_ENV=local
      - SKIP_WEBSERVER=true
    volumes:
      - ./frontend:/app
    command:
      - sh
      - -c
      - |
        echo "Waiting for frontend to be healthy..." &&
        until curl -f http://frontend:3000/ > /dev/null 2>&1; do
          echo "Frontend not ready yet, waiting..."
          sleep 2
        done &&
        echo "Waiting for backend to be healthy..." &&
        until curl -f http://backend:$${BACKEND_PORT:-8000}/health/ > /dev/null 2>&1; do
          echo "Backend not ready yet, waiting..."
          sleep 2
        done &&
        echo "Container up and running....." &&
        corepack enable &&
        yarn install --immutable &&
        yarn playwright install &&
        echo "Running Playwright tests..." &&
        yarn test:local
