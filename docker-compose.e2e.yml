services:
  # Override backend service for E2E: fix health check and add start period
  backend:
    environment:
      - BACKEND_PORT=${BACKEND_PORT}
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "curl -f http://localhost:$BACKEND_PORT/v1/schema/ || exit 1",
        ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 120s

  # Override frontend service for E2E: add --host 0.0.0.0 and fix health check
  # Browsers launched by Playwright in Docker use the container's network, so they can
  # access other services via Docker service names. However, browsers don't resolve Docker
  # DNS by default. Since backend port is exposed, use localhost which works when the
  # browser can access exposed ports, or we'll need to configure DNS resolution.
  # The key fix from CI: ensure backend is fully warmed up before tests start.
  frontend:
    command: sh -c "
      corepack enable && yarn install &&
      if [ \"$${USE_PREVIEW}\" = \"true\" ]; then
      echo 'ðŸ—ï¸  Building frontend for preview mode...' &&
      yarn build &&
      echo 'â–¶ï¸  Starting preview server on port ${FRONTEND_PORT}...' &&
      yarn preview --host 0.0.0.0 --port ${FRONTEND_PORT};
      else
      echo 'â–¶ï¸  Starting dev server...' &&
      yarn dev --host 0.0.0.0 --port ${FRONTEND_PORT};
      fi"
    environment:
      - USE_PREVIEW=${USE_PREVIEW:-false}
      - FRONTEND_PORT=${FRONTEND_PORT}
      # Browsers launched by Playwright may have DNS resolution issues. Since the browser can
      # access http://frontend:3000 (via PLAYWRIGHT_BASE_URL), it should also resolve 'backend'.
      # However, if DNS doesn't work, use host.docker.internal (Mac/Windows) or add extra_hosts.
      # The backend port is exposed, so browsers should be able to reach it via service name.
      - VITE_BACKEND_URL=http://backend:${BACKEND_PORT:-8000}
    healthcheck:
      test:
        ["CMD-SHELL", "curl -f http://localhost:$FRONTEND_PORT/ || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 60s

  e2e-test:
    env_file:
      - .env.dev
    build:
      context: ./frontend
      dockerfile: Dockerfile.e2e
    container_name: e2e-test
    depends_on:
      frontend:
        condition: service_healthy
      backend:
        condition: service_healthy
    # Add extra_hosts for host.docker.internal (Linux compatibility)
    # This allows browsers to access exposed host ports if Docker service names don't resolve
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      - BASE_URL=http://frontend:3000
      - PLAYWRIGHT_BASE_URL=http://frontend:3000
      - TEST_ENV=local
      - SKIP_WEBSERVER=true
      # Set CI=true to ensure global-setup.ts runs full server readiness check
      # (checks for Nuxt compilation completion, not just basic HTTP response)
      - CI=true
      # Use 1 worker in Docker for better resource utilization and stability
      - PLAYWRIGHT_WORKERS=1
    volumes:
      - ./frontend:/app
    command:
      - sh
      - -c
      - |
        echo "Waiting for frontend to be healthy..." &&
        until curl -f http://frontend:3000/ > /dev/null 2>&1; do
          echo "Frontend not ready yet, waiting..."
          sleep 2
        done &&
        echo "Waiting for backend to be healthy..." &&
        until curl -f http://backend:$${BACKEND_PORT:-8000}/v1/schema/ > /dev/null 2>&1; do
          echo "Backend not ready yet, waiting..."
          sleep 2
        done &&
        echo "Warming up backend endpoints..." &&
        curl -s -X OPTIONS http://backend:$${BACKEND_PORT:-8000}/v1/auth/sign_in > /dev/null || true &&
        curl -s http://backend:$${BACKEND_PORT:-8000}/v1/entities/users/ > /dev/null || true &&
        curl -s http://backend:$${BACKEND_PORT:-8000}/v1/entities/organizations/ > /dev/null || true &&
        curl -s http://backend:$${BACKEND_PORT:-8000}/v1/entities/events/ > /dev/null || true &&
        echo "Verifying backend is accessible from e2e-test container..." &&
        curl -v http://backend:$${BACKEND_PORT:-8000}/v1/schema/ 2>&1 | head -10 || echo "Backend not reachable via service name" &&
        echo "Testing if host.docker.internal works..." &&
        curl -v http://host.docker.internal:$${BACKEND_PORT:-8000}/v1/schema/ 2>&1 | head -10 || echo "host.docker.internal not reachable" &&
        echo "Waiting 3 seconds for backend to fully initialize..." &&
        sleep 3 &&
        echo "Container up and running....." &&
        corepack enable &&
        yarn install --immutable &&
        yarn playwright install &&
        echo "Running Playwright tests..." &&
        yarn test:local
